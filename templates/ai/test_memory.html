<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hafıza Egzersizleri</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 2em; }
        .container { max-width: 900px; margin: auto; }
        h1, h2 { color: #2c3e50; }
        .controls, .filters { background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2em; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-filter-memory { background-color: #95a5a6; }
        .btn-filter-memory.active { background-color: #2c3e50; }
        #exercise-list-memory { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1em; }
        .exercise-card { background-color: #fff; padding: 1em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid; }
        .exercise-card.easy { border-color: #2ecc71; }
        .exercise-card.medium { border-color: #f1c40f; }
        .exercise-card.hard { border-color: #e74c3c; }
        .exercise-card h3 { margin-top: 0; }
        .exercise-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 1em;
        }
        .loader { text-align: center; padding: 2em; font-size: 1.2em; display: none; }
    </style>
</head>
<body>

    <!-- Geri Bildirim Modalı -->
    <div id="feedback-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:1001; justify-content:center; align-items:center;">
        <div style="background:white; padding:2em; border-radius:10px; max-width:600px; width: 90%; text-align:left; font-size:1.1em; color:#333; position: relative; line-height: 1.6;">
            <button id="close-feedback-modal-btn" style="position:absolute; top:10px; right:10px; background:#e74c3c; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">X</button>
            <h2 style="margin-top:0; color: #2c3e50; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 1em;">Yazarlık Koçundan Geri Bildirim</h2>
            <div id="feedback-content" style="white-space: pre-wrap;"></div>
        </div>
    </div>


    <div class="container">
        <h1>Hafıza Egzersizleri Test Paneli</h1>
        <div class="controls">
            <h2>Yeni Hafıza Egzersizi Üret</h2>
            <p>Zorluk seviyesi seçip yeni bir hafıza egzersizi üretin. Supabase'e kaydedilecek ve aşağıdaki listede görünecektir.</p>
            <select id="difficulty-select-memory" style="padding: 8px; border-radius: 5px;">
                <option value="easy">Kolay</option>
                <option value="medium">Orta</option>
                <option value="hard">Zor</option>
            </select>
            <button id="create-memory-exercise-btn">Üret ve Kaydet</button>
        </div>

        <div class="filters">
            <h2>Kaydedilmiş Hafıza Egzersizleri</h2>
            <button class="btn-filter-memory active" data-difficulty="all">Tümü</button>
            <button class="btn-filter-memory" data-difficulty="easy">Kolay</button>
            <button class="btn-filter-memory" data-difficulty="medium">Orta</button>
            <button class="btn-filter-memory" data-difficulty="hard">Zor</button>
        </div>

        <div id="loader-memory" class="loader">Yükleniyor...</div>
        <div id="memory-word-display" style="text-align: center; font-size: 2em; margin: 1em 0;"></div>
        <div id="exercise-list-memory"></div>
        <div id="error-message-memory" style="color: red; margin-top: 1em;"></div>
    </div>
    <div id="memory-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:2em; border-radius:10px; max-width:400px; text-align:center; font-size:1.2em; color:#333; position: relative;">
            <button id="close-modal-btn" style="position:absolute; top:10px; right:10px; background:#e74c3c; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">X</button>
            <div id="modal-word-display" style="font-size:1.8em; margin-bottom:1em; height: 50px;"></div>
            <div id="timer-display" style="font-size:1.2em; color:#3498db; margin-bottom:1em; font-weight: bold;"></div>
            <textarea id="user-sentence-input" placeholder="Bu kelimeyle ilgili cümleni yaz..." style="width: 90%; height: 60px; margin-bottom: 1em; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em;"></textarea>
            <div style="margin-bottom:1em;">
                Yukarıdaki kelimeleri sırayla ekranda göreceksin. Her kelime için, bir önceki kelimeyle bağlantılı anlamlı bir cümle kur. En sonda AI sana başka örnek cümleler gösterecek.
            </div>
            <div id="modal-exercise-info" style="font-size: 0.9em; color: #555;"></div>
        </div>
    </div>

</body>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    </script>


    <script>
    const memoryCreateBtn = document.getElementById('create-memory-exercise-btn');
    const memoryDifficultySelect = document.getElementById('difficulty-select-memory');
    const memoryExerciseList = document.getElementById('exercise-list-memory');
    const memoryLoader = document.getElementById('loader-memory');
    const memoryErrorMessage = document.getElementById('error-message-memory');
    const memoryFilterButtons = document.querySelectorAll('.btn-filter-memory');

    // Loader göster/gizle
    const showMemoryLoader = (show) => {
        memoryLoader.style.display = show ? 'block' : 'none';
    };

    // Hata mesajı göster
    const displayMemoryError = (message) => {
        memoryErrorMessage.textContent = message;
    };

    let currentWordIndex = 0;
    let wordsToShow = [];
    let exerciseInterval;
    let timerInterval;
    let userSentences = [];
    let currentExerciseId = null;

    function startMemoryExercise(exercise) {
        wordsToShow = exercise.metadata.raw_words;
        currentExerciseId = exercise.id;
        currentWordIndex = 0;
        userSentences = []; // Egzersiz başladığında cümle dizisini sıfırla
        
        const modal = document.getElementById('memory-modal');
        const modalWordDisplay = document.getElementById('modal-word-display');
        const timerDisplay = document.getElementById('timer-display');
        const sentenceInput = document.getElementById('user-sentence-input');
        
        sentenceInput.value = ''; // Başlangıçta inputu temizle
        sentenceInput.focus();
        modal.style.display = 'flex'; // Modalı görünür yap

        // Cümleyi kaydet ve input'u temizle
        const saveSentenceAndClear = () => {
            const sentence = sentenceInput.value.trim();
            if (sentence) {
                userSentences.push(sentence);
            }
            sentenceInput.value = '';
        };

        // Egzersizi bitir (kapatma butonu veya süre bitince)
        const stopExercise = () => {
            clearInterval(exerciseInterval);
            clearInterval(timerInterval);
            modal.style.display = 'none';
            modalWordDisplay.textContent = '';
            timerDisplay.textContent = '';
        };

        document.getElementById('close-modal-btn').onclick = stopExercise;

        // Enter tuşuna basıldığında cümleyi kaydet
        sentenceInput.onkeydown = (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveSentenceAndClear();
                showNextWord(true); // Hemen bir sonraki kelimeye geç
            }
        };

        // Kelime gösterme ve zamanlayıcı mantığı
        const showNextWord = (forceNext = false) => {
            // Eğer manuel olarak tetiklenmediyse (yani Enter'a basılmadıysa), mevcut cümleyi kaydet
            if (!forceNext) {
                saveSentenceAndClear();
            }

            if (currentWordIndex >= wordsToShow.length) {
                completeExerciseOnServer();
                stopExercise();
                return;
            }

            // Önceki zamanlayıcıyı temizle
            clearInterval(exerciseInterval);
            clearInterval(timerInterval);

            // Kelimeyi göster
            modalWordDisplay.textContent = wordsToShow[currentWordIndex];
            sentenceInput.focus();
            
            // Yeni zamanlayıcıyı başlat
            let timeLeft = 10;
            timerDisplay.textContent = `Kalan Süre: ${timeLeft}s`;

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Kalan Süre: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval); // Bu kelimenin sayacını durdur
                }
            }, 1000);

            currentWordIndex++;
            
            // Bir sonraki kelime için yeni interval ayarla
            exerciseInterval = setInterval(showNextWord, 10000);
        };

        // Egzersizi başlat
        showNextWord(); // İlk kelimeyi hemen göster
    }

    async function completeExerciseOnServer() {
        if (userSentences.length === 0 || !currentExerciseId) {
            console.log("Kaydedilecek cümle yok veya egzersiz ID'si eksik.");
            return;
        }

        const fullParagraph = userSentences.join(' ');
        console.log("Sunucuya gönderilecek paragraf:", fullParagraph);

        try {
            const response = await fetch(`/api/memory/exercises/${currentExerciseId}/complete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ user_paragraph: fullParagraph })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || 'Sunucuya kaydederken hata oluştu.');
            }

            const result = await response.json();
            
            // Geri bildirimi modal'da göster
            if (result.feedback) {
                showFeedbackModal(result.feedback);
            } else {
                alert("Egzersiz tamamlandı ve cevaplarınız kaydedildi!");
            }

        } catch (error) {
            console.error("Egzersiz tamamlama hatası:", error);
            alert(`Bir hata oluştu: ${error.message}`);
        }
    }

    function showFeedbackModal(feedback) {
        const modal = document.getElementById('feedback-modal');
        const contentEl = document.getElementById('feedback-content');
        
        // Gemini'den gelen ** ile işaretlenmiş metni HTML'in <strong> etiketine çevir
        const formattedFeedback = feedback.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        contentEl.innerHTML = formattedFeedback;
        modal.style.display = 'flex';

        document.getElementById('close-feedback-modal-btn').onclick = () => {
            modal.style.display = 'none';
        };
    }

    const fetchAndDisplayMemoryExercises = async (difficulty = null) => {
        showMemoryLoader(true);
        displayMemoryError('');
        memoryExerciseList.innerHTML = '';

        let url = `/api/memory/exercises/`;
        if (difficulty) {
            url += `?difficulty=${difficulty}`;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const exercises = await response.json();

            if (exercises.length === 0) {
                memoryExerciseList.innerHTML = '<p>Gösterilecek hafıza egzersizi bulunamadı.</p>';
            } else {
                exercises.forEach(ex => {
                    const card = document.createElement('div');
                    card.className = `exercise-card ${ex.difficulty}`;

                    const imageUrl = ex.metadata && ex.metadata.image_url ? ex.metadata.image_url : '';
                    const imageElement = imageUrl ? `<img src="${imageUrl}" alt="${ex.title}">` : '';

                    card.innerHTML = `
                        <h3>${ex.title}</h3>
                        <p>${ex.content.substring(0, 100)}...</p>
                        <small>Kategori: ${ex.category}</small><br>
                        <small>Zorluk: ${ex.difficulty}</small>
                    `;
                    
                    // HAFIZA EGZERSİZİ KARTI TIKLAMA OLAYI
                    card.addEventListener('click', () => {
                        startMemoryExercise(ex);
                    });
 
                    memoryExerciseList.appendChild(card);
                });
            }
        } catch (error) {
            displayMemoryError(`Egzersizler yüklenirken bir hata oluştu: ${error.message}`);
        } finally {
            showMemoryLoader(false);
        }
    };

    //Yeni hafıza egzersizi oluştur
    memoryCreateBtn.addEventListener('click', async () => {
        const selectedDifficulty = memoryDifficultySelect.value;
        showMemoryLoader(true);
        displayMemoryError('');
        memoryCreateBtn.disabled = true;

        try {
            const response = await fetch(`/api/memory/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ difficulty: selectedDifficulty })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || 'Bilinmeyen bir hata oluştu.');
            }

            const newExercise = await response.json();

            // Yeni egzersizden gelen kelimeleri sırayla göster, tüm exercise objesini gönderiyoruz
            if (newExercise && newExercise.metadata && newExercise.metadata.raw_words) {
                startMemoryExercise(newExercise);
            }

            await fetchAndDisplayMemoryExercises();
        } catch (error) {
            displayMemoryError(`Egzersiz oluşturulurken bir hata oluştu: ${error.message}`);
        } finally {
            showMemoryLoader(false);
            memoryCreateBtn.disabled = false;
        }
    });


    memoryFilterButtons.forEach(button => {
        button.addEventListener('click', () => {
            memoryFilterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const difficulty = button.dataset.difficulty === 'all' ? null : button.dataset.difficulty;
            fetchAndDisplayMemoryExercises(difficulty);
        });
    });

    //Sayfa ilk açıldığında egzersizleri getir
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndDisplayMemoryExercises();
    });
 </script>
 </body>
 </html> 