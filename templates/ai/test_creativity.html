<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yaratıcılık Egzersizleri</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 2em; }
        .container { max-width: 900px; margin: auto; }
        h1, h2 { color: #2c3e50; }
        .controls, .filters { background-color: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2em; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-filter { background-color: #95a5a6; }
        .btn-filter.active { background-color: #2c3e50; }
        #exercise-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1em; }
        .exercise-card { background-color: #fff; padding: 1em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid; }
        .exercise-card.easy { border-color: #2ecc71; }
        .exercise-card.medium { border-color: #f1c40f; }
        .exercise-card.hard { border-color: #e74c3c; }
        .exercise-card h3 { margin-top: 0; }
        .exercise-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 1em;
        }
        
        #exercise-list-memory {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
            gap: 1em !important;
        }

        .loader { text-align: center; padding: 2em; font-size: 1.2em; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Yaratıcılık Egzersizleri Test Paneli</h1>

        <div class="controls">
            <h2>Yeni Egzersiz Üret</h2>
            <p>Zorluk seviyesi seçip yeni bir egzersiz üretin. Egzersiz Supabase'e kaydedilecek ve aşağıdaki listede görünecektir.</p>
            <select id="difficulty-select" style="padding: 8px; border-radius: 5px;">
                <option value="easy">Kolay</option>
                <option value="medium">Orta</option>
                <option value="hard">Zor</option>
            </select>
            <button id="create-exercise-btn">Üret ve Kaydet</button>
        </div>

        <div class="filters">
            <h2>Kaydedilmiş Egzersizler</h2>
            <button class="btn-filter active" data-difficulty="all">Tümü</button>
            <button class="btn-filter" data-difficulty="easy">Kolay</button>
            <button class="btn-filter" data-difficulty="medium">Orta</button>
            <button class="btn-filter" data-difficulty="hard">Zor</button>
        </div>
        
        <div id="loader">Yükleniyor...</div>
        <div id="exercise-list"></div>
        <div id="error-message" style="color: red; margin-top: 1em;"></div>

    </div>

    <!-- Yaratıcılık Egzersizi Modalı -->
    <div id="creativity-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:2em; border-radius:10px; max-width:500px; width: 90%; text-align:center; font-size:1.1em; color:#333; position: relative;">
            <button id="close-creativity-modal-btn" style="position:absolute; top:10px; right:10px; background:#e74c3c; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">X</button>
            <h3 id="creativity-modal-title" style="margin-top:0;">Egzersiz Başlığı</h3>
            <img id="creativity-modal-image" src="" alt="Egzersiz Resmi" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 4px; margin-bottom: 1em;">
            <p id="creativity-modal-content" style="text-align: left; margin-bottom: 1.5em;"></p>
            <textarea id="creativity-user-story" placeholder="Hikayeni buraya yaz... Enter'a basarak kaydedebilirsin." style="width: 95%; height: 100px; margin-bottom: 1em; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em;"></textarea>
            <button id="save-creativity-story-btn" style="width: 100%; padding: 12px; font-size: 1.1em;">Hikayeyi Kaydet</button>
        </div>
    </div>

    <!-- Geri Bildirim Modalı -->
    <div id="feedback-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:1001; justify-content:center; align-items:center;">
        <div style="background:white; padding:2em; border-radius:10px; max-width:600px; width: 90%; text-align:left; font-size:1.1em; color:#333; position: relative; line-height: 1.6;">
            <button id="close-feedback-modal-btn" style="position:absolute; top:10px; right:10px; background:#e74c3c; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">X</button>
            <h2 style="margin-top:0; color: #2c3e50; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 1em;">Yazarlık Koçundan Geri Bildirim</h2>
            <div id="feedback-content" style="white-space: pre-wrap;"></div>
        </div>
    </div>

</body>

    <script>
        const createBtn = document.getElementById('create-exercise-btn');
        const difficultySelect = document.getElementById('difficulty-select');
        const exerciseList = document.getElementById('exercise-list');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const filterButtons = document.querySelectorAll('.btn-filter');

        // Django'nun CSRF token'ını almak için cookie'den okuma fonksiyonu
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const showLoader = (show) => {
            loader.style.display = show ? 'block' : 'none';
        };

        const displayError = (message) => {
            errorMessage.textContent = message;
        }

        const fetchAndDisplayExercises = async (difficulty = null) => {
            showLoader(true);
            displayError('');
            exerciseList.innerHTML = '';

            let url = `/api/creativity/exercises/`;
            if (difficulty) {
                url += `?difficulty=${difficulty}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const exercises = await response.json();
                
                if (exercises.length === 0) {
                    exerciseList.innerHTML = '<p>Gösterilecek egzersiz bulunamadı.</p>';
                } else {
                    exercises.forEach(ex => {
                        const card = document.createElement('div');
                        card.className = `exercise-card ${ex.difficulty}`;
                        
                        // YENİ YAPI: Metadata'dan gelen verileri kullan
                        const imageUrl = ex.metadata?.image_url || 'https://via.placeholder.com/500x300.png?text=Image+Not+Found';
                        const imageElement = `<img src="${imageUrl}" alt="${ex.title}">`;

                        card.innerHTML = `
                            ${imageElement}
                            <h3>${ex.title}</h3>
                            <p>${ex.content.substring(0, 100)}...</p> 
                            <small>Kategori: ${ex.category}</small><br>
                            <small>Zorluk: ${ex.difficulty}</small>
                        `;
                        
                        // Tıklama olayı ile tam egzersiz verisini modala gönder
                        card.addEventListener('click', () => {
                            openCreativityModal(ex); // 'ex' objesinin tamamını gönderiyoruz
                        });

                        exerciseList.appendChild(card);
                    });
                }
            } catch (error) {
                displayError(`Egzersizler yüklenirken bir hata oluştu: ${error.message}`);
            } finally {
                showLoader(false);
            }
        };

        let currentCreativityExercise = null; // Sadece ID yerine tüm egzersiz objesini tutalım

        function openCreativityModal(exercise) {
            currentCreativityExercise = exercise; // Tüm egzersiz objesini sakla
            const modal = document.getElementById('creativity-modal');
            
            // Yeni veri yapısına göre modalı doldur
            document.getElementById('creativity-modal-title').textContent = exercise.title;
            document.getElementById('creativity-modal-content').innerHTML = exercise.content.replace(/\n/g, '<br>');

            const imageEl = document.getElementById('creativity-modal-image');
            if (exercise.metadata && exercise.metadata.image_url) {
                imageEl.src = exercise.metadata.image_url;
                imageEl.style.display = 'block';
            } else {
                imageEl.style.display = 'none';
            }

            document.getElementById('creativity-user-story').value = '';
            modal.style.display = 'flex';
        }

        document.getElementById('close-creativity-modal-btn').addEventListener('click', () => {
            document.getElementById('creativity-modal').style.display = 'none';
        });

        const saveCreativityStory = async () => {
            const userStory = document.getElementById('creativity-user-story').value.trim();
            if (!userStory || !currentCreativityExercise) {
                alert("Lütfen hikayenizi yazın.");
                return;
            }

            // Butonu devre dışı bırak ve yükleniyor durumu göster
            const saveBtn = document.getElementById('save-creativity-story-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Kaydediliyor ve Geri Bildirim Alınıyor...';

            try {
                const response = await fetch(`/api/creativity/exercises/${currentCreativityExercise.id}/complete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ user_story: userStory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Yaratıcılık modalını kapat
                document.getElementById('creativity-modal').style.display = 'none';

                // Geri bildirim modalını göster
                if (result.feedback) {
                    openFeedbackModal(result.feedback);
                } else {
                    alert("Hikayeniz başarıyla kaydedildi!\n\n(Not: Geri bildirim sadece 'Orta' ve 'Zor' seviye egzersizler için üretilmektedir.)");
                }

            } catch (error) {
                alert(`Bir hata oluştu: ${error.message}`);
            } finally {
                // Butonu tekrar aktif et
                saveBtn.disabled = false;
                saveBtn.textContent = 'Hikayeyi Kaydet';
            }
        };
        
        // Yaratıcılık hikayesini kaydetme butonu
        document.getElementById('save-creativity-story-btn').addEventListener('click', saveCreativityStory);
        
        // Geri bildirim modalını açan fonksiyon
        function openFeedbackModal(feedbackText) {
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackContent = document.getElementById('feedback-content');
            
            // Gelen metindeki markdown'ı (**) HTML'e (<strong>) çevir
            const formattedFeedback = feedbackText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            feedbackContent.innerHTML = formattedFeedback;
            feedbackModal.style.display = 'flex';
        }

        // Geri bildirim modalını kapatma butonu
        document.getElementById('close-feedback-modal-btn').addEventListener('click', () => {
            document.getElementById('feedback-modal').style.display = 'none';
        });
        
        createBtn.addEventListener('click', async () => {
            const selectedDifficulty = difficultySelect.value;
            showLoader(true);
            displayError('');
            
            try {
                const response = await fetch('/api/creativity/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ difficulty: selectedDifficulty })
                });

                // Önce response'un JSON olup olmadığını kontrol et
                const contentType = response.headers.get("content-type");
                if (!response.ok || !contentType || !contentType.includes("application/json")) {
                    const errorText = await response.text();
                    // Eğer dönen hata bir HTML sayfası ise, daha anlamlı bir mesaj göster
                    if (errorText.trim().startsWith('<!DOCTYPE html>')) {
                        throw new Error("Sunucuda bir hata oluştu. Lütfen terminal loglarını kontrol edin.");
                    }
                    throw new Error(errorText || 'Bilinmeyen bir sunucu hatası oluştu.');
                }
                
                const newExercise = await response.json();
                if(newExercise) {
                    // Önce yeni egzersizi modal'da direkt aç
                    openCreativityModal(newExercise);
                    // Ardından arka plandaki listeyi güncelle
                    fetchAndDisplayExercises(document.querySelector('.btn-filter.active').dataset.difficulty);
                } else {
                    throw new Error('Yapay zekadan egzersiz verisi alınamadı veya kaydedilemedi.');
                }

            } catch (error) {
                displayError(`Egzersiz oluşturulurken bir hata oluştu: ${error.message}`);
            } finally {
                showLoader(false);
            }
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const difficulty = button.dataset.difficulty === 'all' ? null : button.dataset.difficulty;
                fetchAndDisplayExercises(difficulty);
            });
        });

        // Sayfa ilk yüklendiğinde tüm egzersizleri getir
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayExercises();
        });
    </script>

 </body>
 </html>